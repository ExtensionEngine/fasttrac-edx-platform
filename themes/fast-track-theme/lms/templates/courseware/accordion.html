<%page expression_filter="h"/>
<%namespace name='static' file='../static_content.html'/>
<%!
    from django.core.urlresolvers import reverse
    from util.date_utils import get_time_display
    from django.utils.translation import ugettext as _
    from django.conf import settings
    from openedx.core.djangolib.markup import HTML, Text

    theme_lms_static = '/edx/app/edxapp/edx-platform/themes/fast-track-theme/lms/static'
%>


<%def name="make_chapter(chapter)">
<%
if chapter.get('active'):
    aria_label = _('{chapter} current chapter').format(chapter=chapter['display_name'])
    active_class = 'active'
else:
    aria_label = chapter['display_name']
    active_class = ''
%>
<a href="#${chapter['display_id']}-child" role="button" class="button-chapter chapter ${active_class}" id="${chapter['display_id']}-parent" aria-controls="${chapter['display_id']}-child" aria-expanded="false">
    <span class="group-heading ${active_class}" aria-label="${aria_label}">
        <div class="icon-container">
            % if chapter['viewed']:
                <i class="fa fa-check-circle"></i>
            % endif
        </div>
        <span class="display-name">${chapter['display_name']}</span>
    </span>
</a>
<div class="chapter-content-container" id="${chapter['display_id']}-child" tabindex="-1" role="group" aria-label="${chapter['display_name']} submenu">
## TODO: remove inline css when sidebar is finished!
    <style type="text/css">

        .icon-container {
            display: inline-block;
            width: 18px;
            vertical-align: top;
        }

        .menu-item .icon-container {
            width: 15px;
        }
        .display-name {
            display: inline-block;
            width: calc(100% - 25px);
        }
        .course-index .accordion .course-navigation .button-chapter .group-heading {
            padding: 10px;
        }

        .course-index .accordion .course-navigation .button-chapter .group-heading.active {
            padding-bottom: 0;
        }

        .course-index .accordion .course-navigation .button-chapter.active .group-heading {
            color: #8d8d8d;
            font-weight: 400;
        }

        .group-heading {
            text-transform: uppercase;
            font-weight: 500;
            color: #8d8d8d;
        }

        .course-index .accordion .course-navigation .chapter-content-container .chapter-menu .menu-item a {
            padding: 5px;
        }

        .course-index .accordion .course-navigation .chapter-content-container.is-open {
            border-bottom: none;
        }

        .group-heading.active {
            color: #f76b1c !important;
        }

        .course-index .accordion .course-navigation .chapter-content-container .chapter-menu .menu-item.graded .accordion-nav,
        .course-index .accordion .course-navigation .chapter-content-container .chapter-menu .menu-item .accordion-nav {
            text-transform: uppercase;
            font-size: 16px;
            font-weight: 400;
        }

        .course-index .accordion .course-navigation .chapter-content-container .chapter-menu .menu-item.active a {
            background: transparent;
            color: #f76b1c;
            text-transform: uppercase;
            font-size: 16px;
            font-weight: 400;
        }

        .course-index .accordion .course-navigation .chapter-content-container {
            border: none;
            padding: 0 10px 0 30px;
        }
        .course-index .accordion .course-navigation .button-chapter {
            box-shadow: none;
            background-color: transparent;
        }

        .course-index .accordion .course-navigation .chapter-content-container .chapter-menu {
            padding: 0;
        }

        a.accordion-nav {
            padding: 0;
        }
        .button-chapter.chapter {
            box-shadow: none;
            background: none;
        }
    </style>
    <div class="chapter-menu">
        % for section in chapter['sections']:
        <div class="menu-item ${'active' if 'active' in section and section['active'] else ''} ${'graded'  if 'graded' in section and section['graded'] else ''}">
            <a class="accordion-nav" href="${reverse('courseware_section', args=[course_id, chapter['url_name'], section['url_name']])}">
                <p class="accordion-display-name">
                    <div class="icon-container">
                        % if section['viewed']:
                            <i class="fa fa-check-circle"></i>
                        % endif
                    </div>
                    <span class="display-name">
                        ${section['display_name']} ${Text(_('{span_start}current section{span_end}')).format(
                            span_start=HTML('<span class="sr">'),
                            span_end=HTML('</span>'),
                        ) if 'active' in section and section['active'] else ''}
                    </span>
                </p>
                <%
                if section.get('due') is None:
                    due_date = ''
                else:
                    formatted_string = get_time_display(section['due'], due_date_display_format, coerce_tz=time_zone)
                    due_date = '' if len(formatted_string)==0 else _('due {date}').format(date=formatted_string)
                %>

                ## There is behavior differences between
                ## rendering of sections which have proctoring/timed examinations
                ## and those that do not.
                ##
                ## Proctoring exposes a exam status message field as well as
                ## a status icon

                % if section['format'] or due_date or 'proctoring' in section:
                <p class="subtitle">
                    % if 'proctoring' in section:
                        ## Display the proctored exam status icon and status message
                        <span class="menu-icon icon fa ${section['proctoring'].get('suggested_icon', 'fa-pencil-square-o')} ${section['proctoring'].get('status', 'eligible')}" aria-hidden="true"></span>
                        <span class="subtitle-name">${section['proctoring'].get('short_description', '')}</span>

                        ## completed proctored exam statuses should not show the due date
                        ## since the exam has already been submitted by the user
                        % if not section['proctoring'].get('in_completed_state', False):
                            <span class="subtitle-name">${due_date}</span>
                        % endif
                    % else:
                        ## non-proctored section, we just show the exam format and the due date
                        ## this is the standard case in edx-platform
                        <span class="subtitle-name">${section['format']} ${due_date}</span>

                        % if 'graded' in section and section['graded']:
                            <span class="menu-icon icon fa fa-pencil-square-o" aria-hidden="true"></span>
                            <span class="sr">${_("This content is graded")}</span>
                        % endif
                    % endif
                </p>
                % endif
            </a>

            % if section and section['active']:
                <ol class="accordion-units">
                    % for unit in section['units']:
                        <li id="accordion-unit-${unit['idx']}" onclick='handleUnitClick("${str(unit)}")'>
                            <div class="icon-container">
                                %if unit['is_bookmarked'] == 'True':
                                    <i class="fa fa-bookmark"></i>
                                %elif unit['viewed'] == 'True':
                                    <i class="fa fa-check-circle"></i>
                                % endif
                            </div>
                            <span class="display-name">${unit['display_name']}</span>
                        </li>
                    % endfor
                </ol>
            % endif
        </div>
        % endfor
    </div>
    <script>
        function highlightActiveUnit() {
            var activeNavUnitId = $('#sequence-list button.active').attr('data-element') - 1;
            $('#accordion-unit-' + activeNavUnitId).addClass('active');
        }

        function handleUnitClick(unitPython) {
            var unit = JSON.parse(unitPython.replace(/u'/g, "'").replace(/&quot;/g, '"').replace(/'/g, '"')); // depythonize
            var tabId = '#tab_' + unit.idx;
            $('.accordion-units li').removeClass('active');
            $('#accordion-unit-' + unit.idx).addClass('active');
            $(tabId).click();
        }

        $(highlightActiveUnit);
    </script>
</div>
</%def>

% for chapter in toc:
    ${make_chapter(chapter)}
% endfor


% if toc:
    <%static:require_module_async module_name="js/courseware/accordion_events" class_name="AccordionEvents">
        AccordionEvents();
    </%static:require_module_async>
% endif

