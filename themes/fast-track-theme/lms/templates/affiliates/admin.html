<%page expression_filter="h"/>
<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%
  from django.utils.timezone import now
%>

<%block name="pagetitle">Site Administration</%block>

<%block name="headextra">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
</%block>

<div id="site-admin" class="container">
  <nav class="top-nav">
    <ul>
      <li class="affiliate-mngmt-link active">Affiliate Management</li>
      <li class="learning-mngmt-link">Learning Management</li>
      <li class="data-exports-link">Data Exports</li>
    </ul>
  </nav>

  <section id="affiliate-mngmt">
    <a class="add-new-affiliate" href="/affiliates/new">Add New Affiliate</a>
    <table class="ft-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>View</th>
          <th>Edit</th>
        </tr>
      </thead>
      <tbody>
        % for affiliate in affiliates:
        <tr>
          <td>${affiliate.name}</td>
          % if affiliate.active:
            <td class="active">Active</td>
            % else:
            <td class="inactive">Inactive</td>
          % endif
          <td><a href="/affiliates/${affiliate.slug}">View</a></td>
          <td><a href="/affiliates/edit/${affiliate.slug}">Edit</a></td>
        </tr>
        % endfor
      </tbody>
    </table>
  </section>

  <section id="learning-mngmt" class="hidden">
    <div id="learner-info">
      <h1>Learner Statistics</h1>

      <div class="learner-info-box">
        <h2>${total_learners}</h2>
        <span>Total Learners</span>
      </div>

      <div class="learner-info-box">
        <h2>${total_affiliate_learners}</h2>
        <span>Total Affiliate Learners</span>
      </div>

      <div class="learner-info-box">
        <h2>${total_fasttrac_learners}</h2>
        <span>Total FastTrac Learners</span>
      </div>
    </div>

    <div id="impersonate-user">
      <h1>Impersonate a User</h1>
      <input type="email" name="email" placeholder="Email of user to impersonate" />
      <button class="btn submit">Impersonate</button>
      <span class="error"></span>
    </div>

    <div id="courses-info">
      <table class="ft-table">
        <thead>
          <tr>
            <th>Affliate Name</th>
            <th>Course Name</th>
            <th>Course Status</th>
            <th>Affiliate Status</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>About Page</th>
            <th>Dashboard</th>
          </tr>
        </thead>
        <tbody>
          % for ccx in ccxs:
          <tr>
            <td>${ccx.affiliate.name}</td>
            <td>${ccx.display_name}</td>
            % if ccx.time < now() < ccx.end_date:
              <td class="active">Active</td>
              % else:
              <td class="inactive">Inctive</td>
            % endif
            % if ccx.affiliate.active:
              <td class="active">Active</td>
              % else:
              <td class="inactive">Inctive</td>
            % endif
            <td>${ccx.time.strftime("%b %d, %Y") if ccx.time else '--'}</td>
            <td>${ccx.end_date.strftime("%b %d, %Y") if ccx.end_date else '--'}</td>
            <td><a href="/courses/${ccx.ccx_course_id}/about">View</a></td>
            <td><a href="/courses/${ccx.ccx_course_id}/edit_custom_course">Dashboard</a></td>
          </tr>
          % endfor
        </tbody>
      </table>
    </div>

  </section>

  <section id="data-exports" class="hidden">

  </section>
</div>

<script>
  $(document).ready(function() {
    // TOP NAVIGATION
    var $affiliateSection = $('section#affiliate-mngmt');
    var $learningSection = $('section#learning-mngmt');
    var $dataDownloadSection = $('section#data-exports');

    $('nav.top-nav li').click(function() {
      $('#site-admin section').addClass('hidden');
      $('nav.top-nav li').removeClass('active');
      if ($(this).hasClass('affiliate-mngmt-link')) {
        $(this).addClass('active');
        $affiliateSection.removeClass('hidden');
      } else if ($(this).hasClass('learning-mngmt-link')) {
        $(this).addClass('active');
        $learningSection.removeClass('hidden');
      } else if ($(this).hasClass('data-exports-link')) {
        $(this).addClass('active');
        $dataDownloadSection.removeClass('hidden');
      }
    });

    // TABLE OPTIONS
    var defaultTableOptions = {
      'info': false,
      'paging': false
    };
    var learningTableOptions = $.extend({
      'order': [
        [0, 'asc'],
        [1, 'asc']
      ]
    }, defaultTableOptions);

    $('#affiliate-mngmt .ft-table').DataTable(defaultTableOptions);
    $('#learning-mngmt .ft-table').DataTable(learningTableOptions);

    // IMPERSONATION
    $('#impersonate-user button.submit').click(function() {
      var $errorField = $('#impersonate-user span.error');
      var $emaiField = $('#impersonate-user input[name=email]');
      var email = $emaiField.val();

      function showError(msg) {
        $errorField.text(msg);
        $emaiField.focus();
      }

      $errorField.text('');

      if (!email) {
        showError('Email field empty.');
      } else if (!$emaiField[0].checkValidity()) {
        showError('Entered email is invalid.');
      } else {
        $.ajax({
          url: '/api/affiliates/impersonate',
          method: 'POST',
          data: {email: email},
          success: function() {
            window.location.href = '/';
          },
          error: function(data) {
            showError(data.responseJSON.msg);
          }
        });
      }
    });
  });
</script>
